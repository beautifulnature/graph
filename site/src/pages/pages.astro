---
import BaseHead from "../components/BaseHead.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import { SITE_TITLE, SITE_DESCRIPTION } from "../consts";
import { getCollection } from "astro:content";
import FormattedDate from "../components/FormattedDate.astro";
import { Image } from "astro:assets";
import { format } from 'date-fns';

export function randomGradient() {
  const deg = Math.floor(Math.random() * 360);
  const color1 = '#' + Math.floor(Math.random()*1048575 + 1048576).toString(16);
  const color2 = '#' + Math.floor(Math.random()*1048575 + 1048576).toString(16);
  return `linear-gradient(${deg}deg, ${color1}, ${color2})`;
}

const blogs = (await getCollection("logseq")).sort((a, b) => {
  if (!a.data.date && !b.data.date) return 0;
  if (!a.data.date) return 1;
  if (!b.data.date) return -1;
  return b.data.date.valueOf() - a.data.date.valueOf();
});

const posts = blogs.filter(
  (post) =>
    post.data.blogtitle || post.data.title
);

type PostsObject = {
  [key: string]: any[];
};
---

<!doctype html>
<html lang="en">
  <head>
    <BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
    <style>
      .placeholder {
        width: 720px;
        height: 360px;
        filter: blur(20px);
      }
    </style>
    <style>
      ul {
        list-style-type: none;
        margin: 0;
        padding: 0;
      }
      ul li {
        display: flex;
        flex-direction: row;
        align-items: start;
        margin-bottom: 1rem;
      }
      ul li img {
        margin-right: 0.5rem;
        border-radius: 12px;
        width: 50px;
        height: 50px;
      }

      .title {
        margin: 0;
        color: rgb(var(--black));
        line-height: 1;
        font-size: 1rem;
      }
      .date {
        margin: 0;
        color: rgb(var(--gray));
        font-size: 0.8rem;
      }
      .description {
        display: none;
      }
      .gradient-bg {
        width: 50px;
        height: 50px;
        border-radius: 12px;
      }
    </style>
  </head>
  <body>
    <Header />
    <main class="w-full max-w-[1000px]">
      <section class="space-y-8">
        <div>
          <h2 class="text-4xl md:text-5xl font-bold mb-4">All Pages</h2>
          {
            Object.entries(posts.reduce((acc: PostsObject, post) => {
              const monthYear = format(new Date(post.data.date), 'MMMM yyyy');
              if (!acc[monthYear]) {
                acc[monthYear] = [];
              }
              acc[monthYear].push(post);
              return acc;
            }, {})).map(([monthYear, posts]) => (
              <>
                <h3>{monthYear}</h3>
                <ul>
                  {
                    posts.map((post) => (
                      <li>
                        <a class="flex items-center" href={`/${post.slug}`}>
                          {post.data.coverimage ? (
                            <Image
                              width={100}
                              height={100}
                              src={post.data.coverimage}
                              alt=""
                              style={{ objectFit: "cover" }}
                            />
                          ) : (
                          <div style={`background: ${randomGradient()};`} class="gradient-bg w-24 h-24"></div>
                          )}
                          <div class="ml-2">
                            <h4 class="title mt-4 line-clamp-3">
                              {post.data.blogtitle || post.data.title}
                            </h4>
                            <p class="date">
                              <FormattedDate date={post.data.date} />
                            </p>
                            <p class="text-sm text-gray-500 mt-2 mb-4">
                              {post.data.description}
                            </p>
                          </div>
                        </a>
                      </li>
                    ))
                  }
                </ul>
              </>
            ))
          }
        </div>
      </section>
    </main>
    <Footer />
  </body>
</html>